<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bible Infinite Scroll</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/babel-standalone@6.26.0/babel.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: #000;
      color: #fff;
    }
    .container {
      max-width: 672px;
      margin: 0 auto;
      padding: 16px;
    }
    .title {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 16px;
    }
    .input {
      background-color: #1f2937;
      color: #fff;
      padding: 8px;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
    }
    .button {
      background-color: #2563eb;
      color: #fff;
      padding: 8px;
      border-radius: 4px;
      margin-top: 8px;
      cursor: pointer;
    }
    .button:hover {
      background-color: #1d4ed8;
    }
    .error {
      color: #ef4444;
      margin-bottom: 16px;
    }
    .loading {
      color: #9ca3af;
      margin-bottom: 16px;
    }
    .subtitle {
      font-size: 1.125rem;
      font-weight: 600;
    }
    .verse {
      padding: 16px 0;
      border-bottom: 1px solid #374151;
    }
    .scroll-area {
      height: 70vh;
      overflow: hidden;
    }
    .slider-container {
      margin: 16px 0;
    }
    .slider-label {
      display: block;
      margin-bottom: 8px;
    }
    .slider {
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <audio id="bgm" loop></audio>
  <script type="text/babel">
    // CDN 로드 확인
    if (!window.React || !window.ReactDOM || !window.Babel) {
      console.error('Failed to load required scripts (React, ReactDOM, or Babel). Please check your network or CDN availability.');
      document.getElementById('root').innerHTML = '<p class="error">스크립트 로드 실패: 네트워크를 확인하거나 나중에 다시 시도하세요. 대안으로 CDN 대신 로컬 파일을 사용할 수 있습니다.</p>';
    } else {
      const { useState, useEffect, useRef } = React;

      const App = () => {
        const [verses, setVerses] = useState([]);
        const [input, setInput] = useState('');
        const [searchResults, setSearchResults] = useState([]);
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);
        const [scrollSpeed, setScrollSpeed] = useState(0.5); // 스크롤 속도 (픽셀/프레임)
        const [speechRate, setSpeechRate] = useState(1); // 음성 재생 속도
        const scrollRef = useRef(null);
        const [scrollPos, setScrollPos] = useState(0);

        // Load saved verses from localStorage
        useEffect(() => {
          const saved = localStorage.getItem('verses');
          if (saved) {
            try {
              setVerses(JSON.parse(saved));
            } catch (e) {
              console.error('Failed to parse verses from localStorage:', e);
              setError('저장된 구절을 불러오지 못했습니다.');
            }
          }
        }, []);

        // Save verses to localStorage
        useEffect(() => {
          try {
            localStorage.setItem('verses', JSON.stringify(verses));
          } catch (e) {
            console.error('Failed to save verses to localStorage:', e);
            setError('구절을 저장하지 못했습니다.');
          }
        }, [verses]);

        // Auto-scrolling logic
        useEffect(() => {
          const scroll = () => {
            setScrollPos((prev) => {
              if (!scrollRef.current) return prev;
              const maxHeight = scrollRef.current.scrollHeight - scrollRef.current.clientHeight;
              if (prev >= maxHeight) return 0;
              return prev + scrollSpeed;
            });
          };
          const interval = setInterval(scroll, 16);
          return () => clearInterval(interval);
        }, [scrollSpeed]);

        // Update scroll position
        useEffect(() => {
          if (scrollRef.current) {
            scrollRef.current.scrollTop = scrollPos;
          }
        }, [scrollPos]);

        // 스크롤 속도에 따라 음성 재생 속도 자동 조절
        useEffect(() => {
          const newSpeechRate = 0.5 + (scrollSpeed - 0.1) * (1.5 / 1.9);
          setSpeechRate(Math.min(Math.max(newSpeechRate, 0.5), 2));
        }, [scrollSpeed]);

        // Search verses using GetBible (KJV) and aromkimm/bible (Korean)
        const searchVerses = async () => {
          setLoading(true);
          setError('');
          try {
            const queries = input.split(',').map(q => q.trim());
            const results = [];
            const bookMap = {
              '창세기': 'Genesis',
              '출애굽기': 'Exodus',
              '레위기': 'Leviticus',
              '민수기': 'Numbers',
              '신명기': 'Deuteronomy',
              '여호수아': 'Joshua',
              '사사기': 'Judges',
              '룻기': 'Ruth',
              '사무엘상': '1 Samuel',
              '사무엘하': '2 Samuel',
              '열왕기상': '1 Kings',
              '열왕기하': '2 Kings',
              '역대상': '1 Chronicles',
              '역대하': '2 Chronicles',
              '에스라': 'Ezra',
              '느헤미야': 'Nehemiah',
              '에스더': 'Esther',
              '욥기': 'Job',
              '시편': 'Psalms',
              '잠언': 'Proverbs',
              '전도서': 'Ecclesiastes',
              '아가': 'Song of Solomon',
              '이사야': 'Isaiah',
              '예레미야': 'Jeremiah',
              '예레미야애가': 'Lamentations',
              '에스겔': 'Ezekiel',
              '다니엘': 'Daniel',
              '호세아': 'Hosea',
              '요엘': 'Joel',
              '아모스': 'Amos',
              '오바댜': 'Obadiah',
              '요나': 'Jonah',
              '미가': 'Micah',
              '나훔': 'Nahum',
              '하박국': 'Habakkuk',
              '스바냐': 'Zephaniah',
              '학개': 'Haggai',
              '스가랴': 'Zechariah',
              '말라기': 'Malachi',
              '마태복음': 'Matthew',
              '마가복음': 'Mark',
              '누가복음': 'Luke',
              '요한복음': 'John',
              '사도행전': 'Acts',
              '로마서': 'Romans',
              '고린도전서': '1 Corinthians',
              '고린도후서': '2 Corinthians',
              '갈라디아서': 'Galatians',
              '에베소서': 'Ephesians',
              '빌립보서': 'Philippians',
              '골로새서': 'Colossians',
              '데살로니가전서': '1 Thessalonians',
              '데살로니가후서': '2 Thessalonians',
              '디모데전서': '1 Timothy',
              '디모데후서': '2 Timothy',
              '디도서': 'Titus',
              '빌레몬서': 'Philemon',
              '히브리서': 'Hebrews',
              '야고보서': 'James',
              '베드로전서': '1 Peter',
              '베드로후서': '2 Peter',
              '요한1서': '1 John',
              '요한2서': '2 John',
              '요한3서': '3 John',
              '유다서': 'Jude',
              '요한계시록': 'Revelation'
            };

            for (const query of queries) {
              const bookMatch = query.match(/^(\D+)/)?.[1]?.trim();
              const book = bookMap[bookMatch] || bookMatch;
              const verseMatch = query.match(/(\d+:\d+(~\d+)?)/)?.[0]?.replace('~', '-');
              if (!book || !verseMatch) throw new Error('잘못된 구절 형식입니다. 예: 창세기 1:1~5');
              const formattedQuery = `${book} ${verseMatch}`;
              const chapter = verseMatch.split('-')[0].split(':')[0];
              const verseRange = verseMatch.split('-');
              const startVerse = parseInt(verseRange[0].split(':')[1]);
              const endVerse = verseRange[1] ? parseInt(verseRange[1]) : startVerse;

              // 영어(KJV) 구절 가져오기 - GetBible API (프록시 사용)
              let kjvText = '영어 구절을 불러오지 못했습니다.';
              try {
                const kjvResponse = await fetch(
                  `/api/getbible/v2/kjv/${formattedQuery}`
                );
                if (!kjvResponse.ok) throw new Error('KJV API 요청 실패: ' + kjvResponse.status);
                const kjvData = await kjvResponse.json();
                if (kjvData.error) throw new Error(kjvData.error);
                const kjvKey = Object.keys(kjvData)[0];
                kjvText = kjvData[kjvKey].verses.map(v => `${v.verse}: ${v.text}`).join(' ');
              } catch (kjvError) {
                console.warn('영어 구절 데이터를 가져오지 못했습니다:', kjvError);
              }

              // 한글(개역개정) 구절 가져오기 - aromkimm/bible (프록시 사용)
              let krvText = '한글 구절을 불러오지 못했습니다.';
              try {
                const koreanResponse = await fetch(
                  `/api/koreanbible/${book}.json`
                );
                if (!koreanResponse.ok) throw new Error('Korean Bible 요청 실패: ' + koreanResponse.status);
                const koreanData = await koreanResponse.json();
                const chapterData = koreanData.find(ch => ch.chapter === parseInt(chapter));
                if (chapterData) {
                  const verses = chapterData.verses.filter(v => v.verse >= startVerse && v.verse <= endVerse);
                  krvText = verses.map(v => `${v.verse}: ${v.text}`).join(' ');
                } else {
                  throw new Error('해당 장을 찾을 수 없습니다.');
                }
              } catch (krvError) {
                console.warn('한글 구절 데이터를 가져오지 못했습니다:', krvError);
              }

              results.push({ query, kjvText, krvText });
            }
            setSearchResults(results);
          } catch (error) {
            console.error('Error fetching verses:', error);
            setError('구절을 불러오지 못했습니다: ' + error.message);
          } finally {
            setLoading(false);
          }
        };

        // Add selected verses
        const addVerses = (verse) => {
          setVerses([...verses, verse]);
          setSearchResults([]);
          setInput('');
          const utterance = new SpeechSynthesisUtterance(verse.kjvText);
          utterance.lang = 'en-US';
          utterance.rate = speechRate;
          window.speechSynthesis.speak(utterance);

          // 한글 음성 재생
          const krUtterance = new SpeechSynthesisUtterance(verse.krvText);
          krUtterance.lang = 'ko-KR';
          krUtterance.rate = speechRate;
          window.speechSynthesis.speak(krUtterance);
        };

        return (
          <div className="container">
            <h1 className="title">Bible Infinite Scroll</h1>
            <div className="mb-4">
              <input
                type="text"
                value={input}
                onChange={(e) => setInput(e.target.value)}
                placeholder="예: 창세기 1:1~5, 시편 23"
                className="input"
              />
              <button
                onClick={searchVerses}
                className="button"
              >
                검색
              </button>
            </div>
            <div className="slider-container">
              <label className="slider-label">스크롤 속도: {scrollSpeed.toFixed(1)}</label>
              <input
                type="range"
                min="0.1"
                max="2"
                step="0.1"
                value={scrollSpeed}
                onChange={(e) => setScrollSpeed(parseFloat(e.target.value))}
                className="slider"
              />
              <p>음성 재생 속도: {speechRate.toFixed(1)}</p>
            </div>
            {loading && <p className="loading">검색 중...</p>}
            {error && <div className="error">{error}</div>}
            {searchResults.length > 0 && (
              <div className="mb-4">
                <h2 className="subtitle">검색 결과</h2>
                {searchResults.map((result, idx) => (
                  <div key={idx} className="verse">
                    <input
                      type="checkbox"
                      onChange={() => addVerses(result)}
                    />
                    <span className="ml-2">{result.query}: {result.kjvText} (KJV)</span>
                    <p className="ml-6">{result.krvText} (개역개정)</p>
                  </div>
                ))}
              </div>
            )}
            <div
              ref={scrollRef}
              className="scroll-area"
            >
              {verses.length > 0 ? (
                verses.concat(verses).map((verse, idx) => (
                  <div key={idx} className="py-4">
                    <p className="text-lg">{verse.kjvText} (KJV)</p>
                    <p className="text-lg">{verse.krvText} (개역개정)</p>
                  </div>
                ))
              ) : (
                <p>구절을 추가하세요.</p>
              )}
            </div>
          </div>
        );
      };

      ReactDOM.render(<App />, document.getElementById('root'));
    }
  </script>
</body>
</html>